// Merkur Mail Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users
model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  passwordHash       String    @map("password_hash")
  firstName          String?   @map("first_name")
  lastName           String?   @map("last_name")
  companyName        String?   @map("company_name")
  isActive           Boolean   @default(true) @map("is_active")
  isVerified         Boolean   @default(false) @map("is_verified")
  twoFactorEnabled   Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret    String?   @map("two_factor_secret")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  lastLoginAt        DateTime? @map("last_login_at")
  deletedAt          DateTime? @map("deleted_at")

  // Relations
  roles              UserRole[]
  credentials        UserCredential?
  documents          Document[]
  recipients         Recipient[]
  mailings           Mailing[]
  refreshTokens      RefreshToken[]
  apiKeys            ApiKey[]
  auditLogs          AuditLog[]

  @@index([email])
  @@index([isActive])
  @@index([deletedAt])
  @@map("users")
}

// Roles
model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions Json?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  users UserRole[]

  @@map("roles")
}

// User Roles (M:N)
model UserRole {
  userId     String   @map("user_id")
  roleId     String   @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// User Credentials (Deutsche Post)
model UserCredential {
  id                String    @id @default(uuid())
  userId            String    @unique @map("user_id")
  provider          String    @default("deutsche_post")
  usernameEncrypted String    @map("username_encrypted")
  passwordEncrypted String    @map("password_encrypted")
  isVerified        Boolean   @default(false) @map("is_verified")
  lastVerifiedAt    DateTime? @map("last_verified_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_credentials")
}

// Documents
model Document {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  fileName   String    @map("file_name")
  filePath   String    @map("file_path")
  fileSize   BigInt    @map("file_size")
  fileHash   String?   @map("file_hash")
  mimeType   String    @default("application/pdf") @map("mime_type")
  pageCount  Int?      @map("page_count")
  status     String    @default("uploaded")
  metadata   Json?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mailings Mailing[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([fileHash])
  @@map("documents")
}

// Recipients
model Recipient {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  firstName         String?   @map("first_name")
  lastName          String?   @map("last_name")
  company           String?
  street            String
  houseNumber       String    @map("house_number")
  postalCode        String    @map("postal_code")
  city              String
  country           String    @default("DE")
  addressSupplement String?   @map("address_supplement")
  isVerified        Boolean   @default(false) @map("is_verified")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mailings Mailing[]

  @@index([userId])
  @@index([postalCode])
  @@map("recipients")
}

// Mailing Status
model MailingStatus {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  isFinal     Boolean  @default(false) @map("is_final")
  isError     Boolean  @default(false) @map("is_error")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  mailings Mailing[]
  events   MailingEvent[]

  @@map("mailing_status")
}

// Mailings
model Mailing {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  documentId        String?   @map("document_id")
  recipientId       String?   @map("recipient_id")
  recipientSnapshot Json      @map("recipient_snapshot")
  mailingType       String    @default("standard") @map("mailing_type")
  colorMode         String    @default("bw") @map("color_mode")
  doubleSided       Boolean   @default(true) @map("double_sided")
  statusId          String?   @map("status_id")
  externalId        String?   @map("external_id")
  trackingNumber    String?   @map("tracking_number")
  costEstimate      Decimal?  @map("cost_estimate") @db.Decimal(10, 2)
  costActual        Decimal?  @map("cost_actual") @db.Decimal(10, 2)
  currency          String    @default("EUR")
  sentAt            DateTime? @map("sent_at")
  deliveredAt       DateTime? @map("delivered_at")
  metadata          Json?
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  document  Document?      @relation(fields: [documentId], references: [id], onDelete: SetNull)
  recipient Recipient?     @relation(fields: [recipientId], references: [id], onDelete: SetNull)
  status    MailingStatus? @relation(fields: [statusId], references: [id])
  events    MailingEvent[]

  @@index([userId])
  @@index([statusId])
  @@index([externalId])
  @@index([trackingNumber])
  @@index([createdAt])
  @@map("mailings")
}

// Mailing Events
model MailingEvent {
  id        String   @id @default(uuid())
  mailingId String   @map("mailing_id")
  statusId  String?  @map("status_id")
  eventType String   @map("event_type")
  message   String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  mailing Mailing        @relation(fields: [mailingId], references: [id], onDelete: Cascade)
  status  MailingStatus? @relation(fields: [statusId], references: [id])

  @@index([mailingId])
  @@index([createdAt])
  @@map("mailing_events")
}

// Audit Logs
model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  entityType   String?  @map("entity_type")
  entityId     String?  @map("entity_id")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  requestData  Json?    @map("request_data")
  responseData Json?    @map("response_data")
  status       String?
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// Refresh Tokens
model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  revoked   Boolean   @default(false)
  revokedAt DateTime? @map("revoked_at")
  ipAddress String?   @map("ip_address")
  userAgent String?   @map("user_agent")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// API Keys
model ApiKey {
  id                  String    @id @default(uuid())
  userId              String    @map("user_id")
  name                String
  keyHash             String    @unique @map("key_hash")
  keyPrefix           String?   @map("key_prefix")
  permissions         Json?
  rateLimitPerMinute  Int       @default(60) @map("rate_limit_per_minute")
  isActive            Boolean   @default(true) @map("is_active")
  lastUsedAt          DateTime? @map("last_used_at")
  expiresAt           DateTime? @map("expires_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
  @@map("api_keys")
}

// System Settings
model SystemSetting {
  key         String   @id
  value       Json
  description String?
  isPublic    Boolean  @default(false) @map("is_public")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}
